const CONSTS={OUTPUT_IMG_WIDTH:5001,OUTPUT_IMG_HEIGHT:5001,SPIRAL_DENSITY:.35,MODULATION_FORCE:25,MODULATION_POS_OFFSET:3,MODULATION_NEG_OFFSET:3,SPIRAL_COLOR_R:127,SPIRAL_COLOR_G:127,SPIRAL_COLOR_B:127,INVALID_COORDINATE:-1};Object.freeze(CONSTS);class Position{constructor(){this.x=CONSTS.INVALID_COORDINATE,this.y=CONSTS.INVALID_COORDINATE}init_position(){this.x=CONSTS.INVALID_COORDINATE,this.y=CONSTS.INVALID_COORDINATE}is_position_empty(){return CONSTS.INVALID_COORDINATE===this.x&&CONSTS.INVALID_COORDINATE===this.y}copy(e){this.x=e.x,this.y=e.y}is_valid(){return this.x>=0&&this.x<CONSTS.OUTPUT_IMG_WIDTH&&this.y>=0&&this.y<CONSTS.OUTPUT_IMG_HEIGHT}}function put_pixel(e,t,T){T[4*t*CONSTS.OUTPUT_IMG_WIDTH+4*e]=CONSTS.SPIRAL_COLOR_R,T[4*t*CONSTS.OUTPUT_IMG_WIDTH+4*e+1]=CONSTS.SPIRAL_COLOR_G,T[4*t*CONSTS.OUTPUT_IMG_WIDTH+4*e+2]=CONSTS.SPIRAL_COLOR_B,T[4*t*CONSTS.OUTPUT_IMG_WIDTH+4*e+3]=255}function draw_line_x(e,t,T){var n=0,a=1;if(e.x<t.x)for(a=(t.y-e.y)/(t.x-e.x),n=e.x;n<=t.x;n++)put_pixel(n,parseInt(e.y+(n-e.x)*a),T);else for(a=(e.y-t.y)/(e.x-t.x),n=t.x;n<=e.x;n++)put_pixel(n,parseInt(t.y+(n-t.x)*a),T)}function draw_line_y(e,t,T){var n=0,a=1;if(e.y<t.y)for(a=(t.y-e.y)/(t.x-e.x),n=e.y;n<=t.y;n++)put_pixel(e.x+parseInt((n-e.y)/a),n,T);else for(a=(e.y-t.y)/(e.x-t.x),n=t.y;n<=e.y;n++)put_pixel(t.x+parseInt((n-t.y)/a),n,T)}function draw_line(e,t,T){var n=0,a=0;if(e.is_valid()&&t.is_valid())if(e.x===t.x)for(a=Math.min(e.y,t.y);a<=Math.max(e.y,t.y);a++)put_pixel(e.x,a,T);else if(e.y===t.y)for(n=Math.min(e.x,t.x);n<=Math.max(e.x,t.x);n++)put_pixel(n,e.y,T);else Math.abs(e.x-t.x)>Math.abs(e.y-t.y)?draw_line_x(e,t,T):draw_line_y(e,t,T)}function create_spiral_pair(e,t,T,n){var a=0,i=0,o=0,I=0,r=0,_=0,s=0,O=0,S=new Position,c=new Position,N=new Position,U=new Position,d=new Position;for(a=0;360*CONSTS.SPIRAL_DENSITY*a+360*CONSTS.SPIRAL_DENSITY<Math.min(CONSTS.OUTPUT_IMG_WIDTH/2-10,CONSTS.OUTPUT_IMG_HEIGHT/2-10);a++)for(s=360*Math.atan(1/(360*CONSTS.SPIRAL_DENSITY*(a+1)))/(2*Math.PI),i=0;i<360;i+=s)o=360*CONSTS.SPIRAL_DENSITY*a+i*CONSTS.SPIRAL_DENSITY,S.x=parseInt(o*Math.sin(2*Math.PI*(i+t)/360)+CONSTS.OUTPUT_IMG_WIDTH/2+1),S.y=parseInt(o*Math.cos(2*Math.PI*(i+t)/360)+CONSTS.OUTPUT_IMG_HEIGHT/2+1),O=0===e[4*S.y*CONSTS.OUTPUT_IMG_WIDTH+4*S.x+3]?0:255-parseInt(.2126*e[4*S.y*CONSTS.OUTPUT_IMG_WIDTH+4*S.x]+.7152*e[4*S.y*CONSTS.OUTPUT_IMG_WIDTH+4*S.x+1]+.0722*e[4*S.y*CONSTS.OUTPUT_IMG_WIDTH+4*S.x+2]),r=o+(_=CONSTS.MODULATION_FORCE*O/255)+CONSTS.MODULATION_POS_OFFSET,I=Math.max(0,o-_-CONSTS.MODULATION_NEG_OFFSET),N.x=parseInt(r*Math.sin(2*Math.PI*(i+t)/360)+CONSTS.OUTPUT_IMG_WIDTH/2+1),N.y=parseInt(r*Math.cos(2*Math.PI*(i+t)/360)+CONSTS.OUTPUT_IMG_HEIGHT/2+1),c.x=parseInt(I*Math.sin(2*Math.PI*(i+t)/360)+CONSTS.OUTPUT_IMG_WIDTH/2+1),c.y=parseInt(I*Math.cos(2*Math.PI*(i+t)/360)+CONSTS.OUTPUT_IMG_HEIGHT/2+1),0===a&&0===i&&(n.is_position_empty()&&n.copy(N),d.copy(n)),draw_line(c,U,T),draw_line(N,d,T),U.copy(c),d.copy(N);return draw_line(N,c,T),n}function progress(e){return console.log(e),document.getElementById("image_upload").classList.add("hidden"),e<0?(document.getElementById("progress").innerText=":(",document.body.style.backgroundColor="#b93636"):e<100?document.getElementById("progress").innerText=e+Math.floor(5*Math.random())+"%":(document.getElementById("progress").innerText="âœ“",document.body.style.backgroundColor="#36b93f"),new Promise(e=>{setTimeout(()=>{e()},50)})}async function process_img(e,t,T,n){if(0===t.width||0===t.height)return console.warn("Invalid picture dimensions"),void progress(-1);var a=0,i=0,o=0,I=0;t.width<t.height?(a=parseInt(CONSTS.OUTPUT_IMG_WIDTH*t.width/t.height),i=CONSTS.OUTPUT_IMG_HEIGHT,o=parseInt((CONSTS.OUTPUT_IMG_WIDTH-a)/2),I=0):(a=CONSTS.OUTPUT_IMG_WIDTH,i=parseInt(CONSTS.OUTPUT_IMG_HEIGHT*t.height/t.width),o=0,I=parseInt((CONSTS.OUTPUT_IMG_HEIGHT-i)/2)),e.canvas.width=CONSTS.OUTPUT_IMG_WIDTH,e.canvas.height=CONSTS.OUTPUT_IMG_HEIGHT,await progress(10),e.filter="drop-shadow(0 0 5px white) blur(3px)",await progress(50),e.drawImage(t,o,I,a,i);var r=e.getImageData(0,0,CONSTS.OUTPUT_IMG_WIDTH,CONSTS.OUTPUT_IMG_HEIGHT),_=new Position,s=e.createImageData(CONSTS.OUTPUT_IMG_WIDTH,CONSTS.OUTPUT_IMG_HEIGHT);await progress(70),_=create_spiral_pair(r.data,0,s.data,_),_=create_spiral_pair(r.data,180,s.data,_),await progress(90),e.putImageData(s,0,0),n.revokeObjectURL(t.src),await progress(100),console.timeEnd();var O=document.createElement("a");O.download=T.name.split(".").slice(0,-1).join(".")+"_spiro.png",O.href=document.getElementById("canvas").toDataURL(),O.click()}function main(){console.log("Start"),console.time();var e=document.getElementById("canvas").getContext("2d"),t=document.getElementById("uploadimage").files[0],T=window.URL||window.webkitURL,n=new Image;n.src=T.createObjectURL(t),n.onload=function(){process_img(e,n,t,T)},n.onerror=function(){console.warn("Error on picture load"),progress(-1)}}document.addEventListener("DOMContentLoaded",function(){document.getElementById("uploadimage").addEventListener("change",main,!1)}),"serviceWorker"in navigator&&navigator.serviceWorker.register("service_worker_min.js").then(function(e){console.log("Registration successful, scope is:",e.scope)}).catch(function(e){console.log("Service worker registration failed, error:",e)});